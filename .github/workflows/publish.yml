name: publish packages
run-name: publish packages

on:
  pull_request:
    branches:
      - test/CV-854/test-workflow
    types:
      - closed


permissions:
  contents: write
  id-token: write

jobs:
  publish:
    if: ${{ github.event.pull_request.merged == true }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: test/CV-854/test-workflow
          fetch-depth: 0

      - uses: actions/setup-node@v5
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org/

      - name: show Node.js and npm versions
        run: |
          echo "Node.js version"
          node -v
          echo ""
          echo "npm version"
          npm -v

      - name: configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Detect publishable package.json
        id: detect
        run: |
          set -e

          BASE="${{ github.event.pull_request.base.sha }}"
          MERGE="${{ github.event.pull_request.merge_commit_sha }}"

          echo "ðŸ” diff from $BASE to $MERGE"

          > publish_targets.txt

          git diff --name-only "$BASE" "$MERGE" \
            | grep '/package.json$' \
            | while read -r PACKAGE_JSON; do
                NAME=$(jq -r '.name' "$PACKAGE_JSON")

                # packages-map.json ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
                if jq -e --arg name "$NAME" 'has($name)' packages-map.json > /dev/null; then
                  echo "$PACKAGE_JSON" >> publish_targets.txt
                else
                  echo "â†ª skip $NAME (not in packages-map.json)"
                fi
              done

          if [ ! -s publish_targets.txt ]; then
            echo "no_packages=true" >> $GITHUB_OUTPUT
          else
            echo "no_packages=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish packages
        if: steps.detect.outputs.no_packages == 'false'
        run: |
          set -e

          BASE="${{ github.event.pull_request.base.sha }}"

          while read -r PACKAGE_JSON; do
            PKG_PATH=$(dirname "$PACKAGE_JSON")

            NAME=$(jq -r '.name' "$PACKAGE_JSON")
            NEW_VERSION=$(jq -r '.version' "$PACKAGE_JSON")
            OLD_VERSION=$(git show "$BASE:$PACKAGE_JSON" | jq -r '.version')

            echo ""
            echo "ðŸ“¦ $NAME"
            echo "  old: $OLD_VERSION"
            echo "  new: $NEW_VERSION"

            if [ "$OLD_VERSION" = "$NEW_VERSION" ]; then
              echo "   â†ª version unchanged, skip"
              continue
            fi

            if npm view "$NAME@$NEW_VERSION" > /dev/null 2>&1; then
              echo "   â†ª already published, skip"
              continue
            fi

            echo "ðŸ“ cd $PKG_PATH"
            cd "$PKG_PATH"

            echo "â¬‡ï¸ npm install"
            npm install

            if jq -e '.scripts.build' package.json > /dev/null; then
              echo "ðŸ—ï¸ npm run build"
              npm run build
            else
              echo "â†ª no build script, skip"
            fi

            echo "ðŸ§ª assert npm publish --dry-run"
            npm publish --dry-run > /dev/null

            echo "ðŸš€ npm publish"
            npm publish --provenance --access public

            echo "ðŸ·ï¸ tag $NAME/v$NEW_VERSION"
            git tag "$NAME/v$NEW_VERSION"

            cd - > /dev/null

          done < publish_targets.txt

          git push origin --tags